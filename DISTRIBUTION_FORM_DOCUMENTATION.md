# فورم توزيع الحيوانات المتطور 📦🐄

## 📋 نظرة عامة

تم تطوير **نظام متكامل لتوزيع الحيوانات** على الدفعات والعنابر، مع واجهة احترافية وميزات متقدمة.

---

## 🎯 الميزات الرئيسية

### 1. واجهة احترافية متطورة ✨

#### مؤشر التقدم (Progress Tracker)
- شريط تقدم بصري يوضح نسبة التوزيع
- عداد الحيوانات المضافة مقابل الإجمالي
- تنبيهات ذكية عند الاكتمال
- رسائل توجيهية للحيوانات المتبقية

#### بطاقات ملخص شاملة
```
┌─────────────────────┬─────────────────────┬─────────────────────┬─────────────────────┐
│ 📊 العدد الإجمالي  │ ⚖️ الوزن الإجمالي  │ 💰 السعر الإجمالي  │ 📏 متوسط الوزن     │
│   50 حيوان         │   12,500 كجم       │   625,000 ج        │   250 كجم          │
│ تم: 30 • باقي: 20  │ تم: 7,500 كجم      │ متوسط: 50 ج/كجم    │   للحيوان الواحد    │
└─────────────────────┴─────────────────────┴─────────────────────┴─────────────────────┘
```

### 2. نموذج إضافة حيوان متقدم 📝

#### الحقول المتاحة:

**الصف الأول - البيانات الأساسية:**
- ✅ **رقم الأذن** (Hash): رقم تعريف فريد لكل حيوان
- ✅ **الجنس**: ذكر 🐂 أو أنثى 🐄
- ✅ **الوزن** (كجم): وزن الحيوان بالكيلوجرام
- ✅ **تاريخ الميلاد**: تاريخ ولادة الحيوان (اختياري)

**الصف الثاني - الموقع والحالة:**
- ✅ **العنبر** (Layers): مكان إيواء الحيوان
- ✅ **الدفعة** (Package): رقم دفعة التكلفة
- ✅ **الحالة الصحية**: 
  - ✅ ممتاز
  - 👍 جيد
  - ⚠️ متوسط
  - 🏥 يحتاج فحص
- ✅ **ملاحظات**: ملاحظات إضافية على الحيوان

### 3. ترقيم تلقائي ذكي 🔢

#### كيف يعمل:
```
الحيوان 1: رقم الأذن = 001
الحيوان 2: رقم الأذن = 002 (تلقائي)
الحيوان 3: رقم الأذن = 003 (تلقائي)
...

أو:
الحيوان 1: رقم الأذن = A-001
الحيوان 2: رقم الأذن = A-002 (تلقائي)
الحيوان 3: رقم الأذن = A-003 (تلقائي)
```

**ميزات الترقيم:**
- يحتفظ بالبادئة (Prefix)
- يحافظ على عدد الأصفار (Padding)
- يمكن تعطيله للترقيم اليدوي
- checkbox لسهولة التبديل

### 4. قائمة الحيوانات المضافة 📋

#### عرض شامل لكل حيوان:

```
┌─────────────────────────────────────────────────────────────────┐
│ [001] 🐂 ذكر                                          [حذف ❌]   │
│                                                                 │
│ العمود 1:              العمود 2:              العمود 3:         │
│ ⚖️ 250 كجم            🏠 عنبر 1              💰 التكلفة        │
│ 📅 2024-01-15         📦 دفعة-1              12,500 ج         │
│                       ✅ ممتاز               50 ج/كجم          │
│                                              💡 ملاحظات...     │
└─────────────────────────────────────────────────────────────────┘
```

**مميزات العرض:**
- 🎨 بطاقات ملونة حسب الحالة الصحية
- 📊 حساب التكلفة التلقائي لكل حيوان
- 🏷️ Badges للجنس والحالة الصحية
- 📝 عرض الملاحظات بشكل واضح
- ⚡ أيقونات تعبيرية
- 🗑️ زر حذف سريع

### 5. ملخص إحصائي شامل 📊

**بطاقة الملخص في الأسفل:**
```
┌───────────────────────────────────────────────────────────────┐
│  إجمالي الحيوانات  │  إجمالي الوزن  │  إجمالي التكلفة  │  متوسط الوزن  │
│        30          │   7,500 كجم    │   375,000 ج     │   250 كجم    │
└───────────────────────────────────────────────────────────────┘
```

### 6. حماية وتحقق من البيانات 🔒

#### التحققات التلقائية:
- ✅ لا يمكن إضافة أكثر من العدد الإجمالي
- ✅ تنبيه عند الوصول للحد الأقصى
- ✅ تعطيل زر الإضافة عند الاكتمال
- ✅ تأكيد قبل حذف جميع الحيوانات
- ✅ التحقق من صحة البيانات (Zod validation)

---

## 💻 التطبيق التقني

### 1. Schema التحقق من البيانات

```typescript
const animalDistributionSchema = z.object({
  earTag: z.string().min(1, "رقم الأذن مطلوب"),
  sex: z.enum(["ذكر", "أنثى"]),
  birthDate: z.string().optional(),
  weight: z.string().min(1, "الوزن مطلوب"),
  healthStatus: z.enum(["ممتاز", "جيد", "متوسط", "يحتاج فحص"]).default("جيد"),
  penNumber: z.string().min(1, "رقم العنبر مطلوب"),
  batchNumber: z.string().optional(),
  notes: z.string().optional(),
});
```

### 2. State Management

```typescript
const [animals, setAnimals] = useState<AnimalDistribution[]>([]);
const [autoIncrement, setAutoIncrement] = useState(true);

// Calculated values
const totalDistributedWeight = animals.reduce(
  (sum, animal) => sum + parseFloat(animal.weight || "0"), 0
);
const remainingAnimals = parseInt(reception.totalAnimals) - animals.length;
const distributionProgress = (animals.length / parseInt(reception.totalAnimals)) * 100;
```

### 3. Auto-Increment Logic

```typescript
useEffect(() => {
  if (autoIncrement && animals.length > 0) {
    const lastEarTag = animals[animals.length - 1].earTag;
    const match = lastEarTag.match(/(\d+)$/);
    if (match) {
      const nextNumber = parseInt(match[1]) + 1;
      const prefix = lastEarTag.substring(0, lastEarTag.length - match[1].length);
      form.setValue("earTag", prefix + nextNumber.toString().padStart(match[1].length, '0'));
    }
  }
}, [animals.length, autoIncrement]);
```

### 4. Cost Calculation

```typescript
const calculatedCost = 
  (parseFloat(animal.weight) / parseFloat(reception.totalWeight)) *
  parseFloat(reception.totalPrice);

// التكلفة للكيلو = التكلفة الإجمالية / الوزن
const costPerKg = calculatedCost / parseFloat(animal.weight);
```

### 5. Data Fetching (React Query)

```typescript
// Fetch pens
const { data: pens = [] } = useQuery({
  queryKey: ["/api/pens"],
  queryFn: async () => {
    const response = await fetch("/api/pens");
    if (!response.ok) throw new Error("فشل في جلب العنابر");
    return response.json();
  },
});

// Fetch batches
const { data: batches = [] } = useQuery({
  queryKey: ["/api/batches"],
  queryFn: async () => {
    const response = await fetch("/api/batches");
    if (!response.ok) throw new Error("فشل في جلب الدفعات");
    return response.json();
  },
});
```

---

## 🎨 تحسينات الواجهة

### 1. الألوان والأيقونات

#### بطاقات الملخص:
- 🔵 **أزرق**: العدد الإجمالي
- 🟣 **بنفسجي**: الوزن الإجمالي
- 🟢 **أخضر**: السعر الإجمالي
- 🟠 **برتقالي**: متوسط الوزن

#### الحالة الصحية:
- ✅ **أخضر**: ممتاز
- 👍 **أزرق**: جيد
- ⚠️ **أصفر**: متوسط
- 🏥 **أحمر**: يحتاج فحص

### 2. Responsive Design

```
Desktop (> 768px):
- 4 بطاقات في صف واحد
- فورم من 4 أعمدة
- عرض كامل للتفاصيل

Mobile (< 768px):
- بطاقة واحدة في كل صف
- فورم من عمود واحد
- عرض مختصر مع scroll
```

### 3. Interactive Elements

- 🖱️ **Hover effects** على البطاقات
- ✨ **Transitions** سلسة
- 📱 **Touch-friendly** على الموبايل
- ⌨️ **Keyboard navigation**

---

## 🔄 سير العمل

### خطوة بخطوة:

1. **افتح فورم التوزيع**
   - من صفحة الاستقبال
   - اضغط "توزيع الحيوانات"

2. **شاهد ملخص الدفعة**
   - العدد الإجمالي
   - الوزن والسعر
   - متوسطات الحساب

3. **أضف حيوان**
   - أدخل رقم الأذن (أو استخدم الترقيم التلقائي)
   - اختر الجنس
   - أدخل الوزن
   - اختر العنبر والدفعة
   - حدد الحالة الصحية
   - أضف ملاحظات (اختياري)

4. **راجع البيانات**
   - شاهد الحيوان في القائمة
   - تحقق من التكلفة المحسوبة
   - عدّل أو احذف إذا لزم

5. **كرر العملية**
   - أضف باقي الحيوانات
   - راقب شريط التقدم

6. **احفظ التوزيع**
   - عند الاكتمال
   - يتم إنشاء سجلات الحيوانات
   - تحديث حالة الاستقبال

---

## 📊 حالات الاستخدام

### حالة 1: توزيع دفعة أبقار

```
المعطيات:
- الدفعة: RCP-20251011-123456
- النوع: أبقار - فريزيان
- العدد: 20
- الوزن: 5,000 كجم
- السعر: 500,000 ج

التوزيع:
┌─────┬──────┬────────┬────────┬────────┬──────────┐
│ الأذن│ الجنس│ الوزن  │ العنبر│ الدفعة │ التكلفة  │
├─────┼──────┼────────┼────────┼────────┼──────────┤
│ 001 │ أنثى │ 250 كجم│ عنبر 1│ دفعة-1│ 25,000 ج│
│ 002 │ أنثى │ 245 كجم│ عنبر 1│ دفعة-1│ 24,500 ج│
│ 003 │ ذكر  │ 260 كجم│ عنبر 2│ دفعة-1│ 26,000 ج│
│ ... │ ...  │ ...    │ ...    │ ...    │ ...      │
└─────┴──────┴────────┴────────┴────────┴──────────┘

النتيجة:
✅ 20 حيوان تم توزيعهم
✅ التكلفة الإجمالية: 500,000 ج
✅ متوسط التكلفة: 25,000 ج/حيوان
```

### حالة 2: توزيع مواليد جديدة

```
المعطيات:
- الدفعة: RCP-20251011-234567
- النوع: أغنام - برقي
- المصدر: مواليد داخلية 🍼
- العدد: 30
- الوزن: 90 كجم
- السعر: 0 ج (مواليد)

التوزيع:
- جميع المواليد: تكلفة = 0
- تاريخ الميلاد: نفس اليوم
- الحالة الصحية: يحتاج فحص (للمتابعة)
- العنبر: عنبر المواليد
- الدفعة: دفعة الأمهات

النتيجة:
✅ 30 مولود تم تسجيلهم
✅ التكلفة: 0 ج
✅ جاهزين للمتابعة والرعاية
```

---

## 🚀 الميزات المستقبلية (اقتراحات)

### قريباً:

- [ ] **استيراد من Excel**: رفع ملف Excel بالحيوانات
- [ ] **طباعة Barcode**: طباعة ملصقات أرقام الأذن
- [ ] **كاميرا**: مسح Barcode بالكاميرا
- [ ] **صور الحيوانات**: إضافة صور لكل حيوان
- [ ] **AI للوزن**: تقدير الوزن من الصورة
- [ ] **تقارير PDF**: تقرير كامل للدفعة
- [ ] **توزيع سريع**: توزيع تلقائي بمعايير محددة
- [ ] **تاريخ التطعيمات**: تتبع التطعيمات مباشرة
- [ ] **ربط بالأم**: ربط المواليد بأمهاتها
- [ ] **QR Code**: رمز QR لكل حيوان

---

## 📝 ملاحظات مهمة

### ⚠️ نقاط الانتباه:

1. **رقم الأذن الفريد**
   - يجب أن يكون فريداً لكل حيوان
   - لا يمكن تكراره في النظام
   - استخدم نظام ترقيم واضح

2. **دقة الوزن**
   - الوزن مهم لحساب التكلفة
   - تأكد من دقة الميزان
   - سجل الوزن بالكيلوجرام

3. **العنابر والدفعات**
   - تأكد من إنشاء العنابر أولاً
   - الدفعات اختيارية لكن مهمة للتكاليف
   - يمكن تغييرها لاحقاً

4. **الحالة الصحية**
   - سجل الحالة الفعلية
   - "يحتاج فحص" للمتابعة
   - تحديث الحالة دورياً

5. **الحفظ النهائي**
   - راجع جميع البيانات قبل الحفظ
   - الحفظ نهائي (لا يمكن التراجع)
   - يمكن تعديل بيانات الحيوان لاحقاً

---

## 🎓 أمثلة عملية

### مثال 1: توزيع دفعة كبيرة (100 حيوان)

```javascript
// استخدم الترقيم التلقائي
1. فعّل checkbox "ترقيم تلقائي"
2. ابدأ برقم: A-001
3. أدخل بيانات أول حيوان
4. اضغط "إضافة الحيوان"
5. الحيوان التالي سيكون: A-002 تلقائياً
6. استمر حتى A-100

// النتيجة:
✅ توفير الوقت 80%
✅ لا أخطاء في الترقيم
✅ نظام موحد
```

### مثال 2: توزيع على عنابر متعددة

```javascript
// العنبر 1: الإناث
الحيوانات 1-30:
- الجنس: أنثى
- العنبر: عنبر 1
- الدفعة: دفعة-1

// العنبر 2: الذكور
الحيوانات 31-50:
- الجنس: ذكر
- العنبر: عنبر 2
- الدفعة: دفعة-2

// النتيجة:
✅ تنظيم واضح
✅ سهولة الإدارة
✅ تقارير دقيقة
```

---

## 📚 الخلاصة

فورم توزيع الحيوانات المتطور يوفر:

✅ **واجهة احترافية** سهلة الاستخدام  
✅ **ترقيم تلقائي** ذكي  
✅ **حسابات دقيقة** للتكاليف  
✅ **عرض شامل** للبيانات  
✅ **حماية من الأخطاء**  
✅ **تكامل كامل** مع النظام  
✅ **مرونة عالية** في الإدخال  

---

**تاريخ التطوير**: أكتوبر 2025  
**الإصدار**: 2.0 (محسّن)  
**الحالة**: ✅ جاهز للإنتاج
